#!/usr/bin/env python2
import commands
import os
import shutil
import stat
import subprocess
import sys
import tempfile

DEBUG = False

def main(argv):
  try:
    tool = subprocess.check_output(['git', 'config', '--get', 'multidiff.tool']).strip()
  except subprocess.CalledProcessError as exc:
    print >>sys.stderr, \
        'Error: %r returned status %r' % (' '.join(exc.cmd), exc.returncode)
    sys.exit(1)

  tmpdir = os.path.join(tempfile.mkdtemp(), '')
  try:
    os.environ['GIT_MULTIDIFF_TEMP'] = tmpdir
    argsfile = os.path.join(tmpdir, 'args')
    open(argsfile, 'w').close()
    subprocess.check_call(['git', 'difftool', '-y', '-x',
        '_git-multidiff-helper'] + argv[1:])
    difftool_args = [x for x in
        open(argsfile).read().split('\0')
        if x]
    assert not (len(difftool_args) % 2), \
        "Expected even number of files, but got %d" % len(difftool_args)

    for fnam in set(difftool_args):
      if fnam.startswith(tmpdir):
        file_stat = os.stat(fnam)
        if file_stat.st_nlink == 1:
          try:
            perms = file_stat.st_mode \
                & ~(stat.S_IWGRP | stat.S_IWOTH | stat.S_IWUSR)
            os.chmod(fnam, perms)
            if DEBUG: print 'chmod a-r %r' % fnam
          except IOError:
            pass

    if difftool_args:
      os.system(tool + ''.join(commands.mkarg(x) for x in difftool_args))
  finally:
    shutil.rmtree(tmpdir, ignore_errors=True)

if __name__ == '__main__':
  main(sys.argv)

